[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Analyzing Candian demographic and housing data using R",
    "section": "",
    "text": "This book is intended for people interested in learning how to access, process, analyze, and visualize Canadian demographic, economic, and housing data using R. The target audience we have in mind ranges from interested individuals interested in understanding their environment through data, community activists and community groups interested in introducing data-based approached into their work, journalists who want to report on data in their stories or aim to incorporate their own descriptive data analysis, non-profits or people involved in policy who are looking for data-based answers to their questions.\nThe most important prerequisite is a keen interest in using data to help understand how housing and demographics shape cities and rural areas in Canada, and a willingness to learn. Prior knowledge of R is not necessary, but may be beneficial.\nCanada has high quality demographic, economic and housing data. While significant data gaps exist, the available data often remains under-utilized in policy and planning analyses. Moreover, many analyses that do come out go quickly out of date and can’t easily be updated because they rely on non-reproducible and non-adaptable workflows.\nIn this book we will maintain a strong emphasis on reproducible and adaptable work flows to ensure the analysis is transparent, can easily be updated as new data becomes available, and can be tweaked or adapted to address related questions.\n\n\nThis book will take a project based approach to to teach through examples, with one project per section. Each project will be loosely broken up into four parts.\n\nFormulating the question. What is the question we are interested in? Asking a clear question will help focus our efforts and ensure that we don’t aimlessly trawl through data.\nIdentifying possible data sources. Here we try to identify data sources that can speak to our question. We will also take the time to read up on definitions and background concepts to better understand the data and prepare us for data analysis, and understand how well the concepts in the data match our original question from step 1.\nData acquisition. In this step we will import the data into our current working session. This could be as simple as an API call, or more complicated like scraping we table from the web, or involve even more complex techniques to acquire the data.\nData preparation. In this step we will reshape and filter the data to prepare it for analysis.\nAnalysis. This step could be as simple as computing percentages or even doing nothing, is the quantities we are interested in already come with the dataset, if our question can be answered by a simple descriptive analysis. In other cases, when our question is more complex, this step may be much more involved. The book will try to slowly build up analysis skills along the way, with increasing complexity of questions and required analysis.\nVisualization. The final step in the analyusis process is to visualize and communicate the results. In some cases this can be done via a table or a couple of paragraphs of text explaining the results, but in most cases it is useful to produce graphs or maps or even interactive visualizations to effectively communicate the results.\nInterpretation. What’s left to wrap this up is to interpret the results. How does this answer our question, where does it fall short. What does this mean in the real-world context? What new questions emerge from this?\n\nWhile we won’t always follow this step by step process to the letter, it will be our guiding principle throughout the book. Sometimes things won’t go so clean, where after the visualization step we notice that something looks off or is unexpected, and we may jump back up a couple of steps and add more data and redo parts of the analysis to better understand our data and how it speaks to our initial questions. We might even come to understand that our initial question was not helpful or was ill-posed, and we will come back to refine it.\n\n\n\nBy taking this approach we have several goals in mind:\n\nStay motivated by using real world Canada-focused and (hopefully) interesting examples.\nTeach basic data literacy, appreciate definitions and quirks in the data.\nExpose the world of Canadian data and make it more accessible.\nLearn how data can be interpreted in different ways, and data and analysis is not necessarily “neutral”.\nLearn how to effectively communicate results.\nLearn how to adapt and leverage off of previous work to answer new questions.\nLearn how to reproduce and critique data analysis.\nBuild a community around Canadian data, where people interested in similar questions, or people using the same data, can learn from each other.\nRaise the level of understanding of Canadian data and data analysis so we are better equipped to tackle the problems Canada faces.\n\nThis is setting a very high goal for this book, and we are not sure we can achieve all of this. But we will try our best to be accessible and interesting as possible.\n\n\n\nMost people reading this book will not have used R before, or only used it peripherally, maybe during a college course many years in the past. Instead, readers may be familiar with working through housing and demographic data in Excel or similar tools. Or making maps in QGIS or similar tools when dealing with spatial data. And the type of analysis outlined above that this book will teach can in general terms be accomplished using these tools.\nBut where tools like spreadsheets and desktop GIS fall short is in another important focus of this book: transparency, reproducibility, and adaptability.\nAn analysis in a spreadsheet or desktop GIS typically involves a lot of manual steps, the work is not reproducible without repeating these steps. We can’t easily inspect how the result was derived, the analysis lacks transparency. When we just compute a ratio or percentage this may not be so bad, but trying to understand how a more complex analysis was done in a spreadsheet easily turns into a nightmare. Analysis that involves a lot of manual steps is not auditable without putting in the work to repeat those manual steps.\nBut why does this matter? It’s always been this way, some experts produce analysis and produce a glossy paper to present the results. One can argue if this was an adequate modus operandi in the past, but we feel strongly that it’s not in today’s world. The lines between experts and non-experts has become blurred, and the value we place on lived experience has increased relative to more formal expertise. We argue this places different demands on policy-relevant analysis, it needs to be open and transparent, in principle anyone should be able to understand how the analysis was done and the conclusions were reached. That’s where reproducibility and transparency come in. And it also requires bringing up data analysis skills in the broader population, so that the ability to reproduce and critique an analysis in principle can be realized in practice.\nThe remaining reason for using R, adaptability, has also become increasingly important. The amount of data available to us has increased tremendously, but our collective ability to analyse data and extract information has not kept up. Doing analysis in R allows us to efficiently reuse previous analysis to perform a similar one. Or to build on previous analysis to deepen it. Which turbocharges our ability to do analysis, covering more ground and going deeper.\nR is not the only framework to do this in, there are other options like python or julia. But we believe that R is best suited for people transitioning into this space, and we can rely on an existing ecosystem of packages to access and process Canadian data. People already proficient in python will have no problem translating what we do into their preferred framework, or dynamically switch back and forth between R, python or whatever other tools they prefer as needed and convenient.\n\n\n\nWhich brings us to our most ambitious goal, to help create a community around Canadian data analysis. When analysis is transparent, reproducible and adaptable people can piggy-back of each other’s work, reusing parts of analysis others have done and building and improving upon it. Or Critiquing and correcting analysis, or taking it toward a different direction. A community that grows in their understanding of data, and a community using a shared set of tools to access and process Canadian data, enabling discussions to move forward instead of in circles. A community that builds up expertise from the bottom up.\nThe book tries to address both of these requirements for building a Canadian data community, a principled approach to data and data analysis, while introducing R as a common framework to work in hoping that the reader will come away with\n\nbetter data literacy skills to understand and critique data analysis,\ntechnical skills to reproduce and perform their own data analysis, and\na common tool set for acquiring, processing and analyzing Canadian data that facilitates collaborative practices."
  },
  {
    "objectID": "intro.html",
    "href": "intro.html",
    "title": "1  Introduction",
    "section": "",
    "text": "In this section we give a taste of what’s to come. Some of the concepts introduced in the preface may be too abstract to picture for people just starting out in this space. People probably grasp the importance of having a principled approach to data analysis, from formulating a question all the way to sharing results. But why so much emphasis on reproducibility and adaptability? And do we really need to learn a new framework like R for this?\nThis is best understood by walking through a simple example of what analysis of Canadian data in R, and a Canadian data community might look like. We won’t explain all steps in full detail here, this is to serve to illustrate the concepts talked above in the preface and give the reader a taste of what’s to come.\nIf you don’t understand all the code now, don’t worry, that’s part of the point of this book. We will work out and explain these examples in detail in the first chapter of the book. What’s important right now is to illustrate the principle of reproducible and adaptable code, and how this can function to foster a community of Canadian data analysis. And to note how little code is needed to make this work."
  },
  {
    "objectID": "intro.html#a-hypothetical-example",
    "href": "intro.html#a-hypothetical-example",
    "title": "1  Introduction",
    "section": "1.1 A hypothetical example",
    "text": "1.1 A hypothetical example\nImagine Amy, a Toronto-based social services worker looking to pilot a community intervention targeted at children in low income. She is in the process of putting together a proposal describing her intervention and is trying to locate a good neighbourhood for her pilot and make a compelling case to possible funders.\nAmy knows that census data has a good geographic breakdown of children in poverty, but the latest available data is from 2016, using 2015 income data. CRA tax data is available up to 2019, but also has information on families in low income, but nothing directly on children in the standard release tables at fine geographies. As a first step she settles on census data, with the goal to re-run the analysis once the 2021 data comes out later in the year.\nShe refers to the Census Dictionary to understand the various low income measures, and uses CensusMapper’s interactive map that allows to explore these concepts. She would have liked to use the Market Based Measure, but due to data availability she settles for LICO-AT.\nShe sets up a new Notebook and loads in the R libraries that she will need for this, ggplot2for graphing and cancensus for ingesting the data.\n\nlibrary(cancensus)\nlibrary(ggplot2)\n\nNext she pull in the data. the CensusMapper API GUI tool helps her locate the StatCan geographic identifier for Toronto, (3520005), and the internal CensusMapper vector for the percentage of children in LICO-AT (v_CA16_2573).\n\nlico_yyz <- get_census(\"CA16\",regions=list(CSD=\"3520005\"), vectors=c(lico=\"v_CA16_2573\"),\n                        level=\"CT\",geo_format=\"sf\")\n\nHere Amy specified that she wants data for the 2016 Canadian census (“CA16”), the region and vectors, at the census tract (“CT”) level, with geographies as well as the low income data.\nNow that she has the data at her finger times her first step is to make a map. For that she needs to tell ggplot is what variable to use as fill colour, and maybe give it a nicer colour scale and some labels to explain what the map is about.\n\nggplot(lico_yyz, aes(fill=(lico/100))) +\n  geom_sf() +\n  scale_fill_viridis_c(labels=scales::percent) +\n  coord_sf(datum=NA) +\n  labs(title=\"Children in low income (LICO-AT)\",\n       fill=\"Share\",\n       caption=\"StatCan census 2016\")\n\n\n\n\nBased on this she locates a couple of good candidate neighbourhoods for her pilot and sends the map in a email to her colleague Peter to get input on which neighbourhood might be best suited.\nPeter has some good feedback for Amy, but also gets an idea to try and set up something similar in Vancouver. Peter asks Amy if she can share the code, and Amy sends along the above code snippets. Peter looks up the geographic identifier for Vancouver and subs that in instead of Toronto’s.\n\nlico_yvr <- get_census(\"CA16\",regions=list(CSD=\"5915022\"), vectors=c(lico=\"v_CA16_2573\"),\n                        level=\"CT\",geo_format=\"sf\")\n\nggplot(lico_yvr, aes(fill=(lico/100))) +\n  geom_sf() +\n  scale_fill_viridis_c(labels=scales::percent) +\n  coord_sf(datum=NA) +\n  labs(title=\"Children in low income (LICO-AT)\",\n       fill=\"Share\",\n       caption=\"StatCan census 2016\")\n\n\n\n\nEasy peasy, thanks to Amy’s previous work. Peter takes the map to his friend Yuko and asks her for advice where a community-based intervention for low-income children might make sense in Calgary. Yuko asks for the code from Peter to take a closer look herself.\nYuko is interested in a finer geographic breakdown, so she swaps our the geographic level from census tracts to dissemination areas.\n\nlico_yvr_da <- get_census(\"CA16\",regions=list(CSD=\"5915022\"), vectors=c(lico=\"v_CA16_2573\"),\n                        level=\"DA\",geo_format=\"sf\")\n\nggplot(lico_yvr_da, aes(fill=(lico/100))) +\n  geom_sf(size=0.1) +\n  scale_fill_viridis_c(labels=scales::percent) +\n  coord_sf(datum=NA) +\n  labs(title=\"Children in low income (LICO-AT)\",\n       fill=\"Share\",\n       caption=\"StatCan census 2016\")\n\n\n\n\nBut then Yuko pauses to think that maybe looking at share of the low income population is not the right metric. She decides to query the number of children in low income (vector “v_CA16_2558”) and prepare the data for a dot-density map.\n\n# remotes::install_github(\"mountainmath/dotdensity\")\nlibrary(dotdensity)\n\nlico_dots_yvr <- get_census(\"CA16\",regions=list(CSD=\"5915022\"),geo_format=\"sf\",\n                            vectors=c(lico=\"v_CA16_2558\"), level=\"DA\") |>\n  compute_dots(\"lico\")\nyvr_city <- get_census(\"CA16\",regions=list(CSD=\"5915022\"),geo_format=\"sf\")\n\nggplot(lico_dots_yvr) +\n  geom_sf(data = yvr_city) +\n  geom_sf(size=0.25,colour=\"brown\",alpha=0.1) +\n  coord_sf(datum=NA) +\n  labs(title=\"Children in low income (LICO-AT)\",\n       fill=\"Share\",\n       caption=\"StatCan census 2016\")\n\n\n\n\nThat paints a somewhat different picture, and Yuko feels this is much better suited to pinpoint where to best stage a community intervention. She lets Peter and Amy know and emails them her modifications to the code.\nMeanwhile, Yuko’s Vancouver friend Stephanie is looking specifically at children below the age of 6 in low income, and wants to understand how the geographic distribution of low income children has changed over time. Comparing census data through time can be tricky because census geographies change, but this problem has been completely solved via the tongfen R package. Looking at Yuko’s work she thinks it might be best to look at both, the change in share of children in low income as well as the change in absolute number.\n\nlibrary(tongfen)\nmeta <- meta_for_ca_census_vectors(c(total_2006=\"v_CA06_1982\",lico_share_2006=\"v_CA06_1984\",\n                                     lico_2016=\"v_CA16_2561\",lico_share_2016=\"v_CA16_2576\"))\n\nlico_data <- get_tongfen_ca_census(regions=list(CSD=\"5915022\"),meta,level=\"CT\") |>\n  mutate(lico_2006=total_2006*lico_share_2006/100) |>\n  mutate(`Absolute change`=lico_2016-lico_2006,\n         `Percentage point change`=lico_share_2016-lico_share_2006)\n\nArmed with this data Stephanie can plot the absolute and percentage point change in children below 6 in low income.\n\nggplot(lico_data,aes(fill=`Absolute change`)) +\n  geom_sf() +\n  scale_fill_gradient2() +\n  coord_sf(datum=NA) +\n  labs(title=\"Change in number of children under 6 in low income\",\n       caption=\"StatCan Census 2006, 2016\")\n\n\n\n\n\nggplot(lico_data,aes(fill=`Percentage point change`/100)) +\n  geom_sf() +\n  scale_fill_gradient2(labels=scales::percent) +\n  coord_sf(datum=NA) +\n  labs(title=\"Change in share of children under 6 in low income\",\n       fill=\"Percentage\\npoint change\",\n       caption=\"StatCan Census 2006, 2016\")\n\n\n\n\nStephanie shares her results with Amy in Toronto in case there are components of Amy’s pilot specifically targeting children below 6 in low income.\nMeanwhile Amy has been trying to understand more broadly how the share of low income children has evolved since the 2016 census (using 2015 income data) at the metropolitan level over longer time spans, so she looks through the StatCan socioeconomic tables and settles on table 11-10-0135, which also allows her to compare various low income concepts.\n\nlibrary(cansim)\nmbm_timeline <- get_cansim(\"11-10-0135\") |>\n  filter(`Persons in low income`==\"Persons under 18 years\",\n         GEO==\"Toronto, Ontario\",\n         Statistics==\"Percentage of persons in low income\")\n\nggplot(mbm_timeline,aes(x=Date,y=val_norm,colour=`Low income lines`)) +\n  geom_point(shape=21) +\n  geom_line() +\n  scale_y_continuous(labels=scales::percent) +\n  labs(title=\"Children in low income in Metro Toronto\",\n       y=\"Share of children in low income\",\n       x=NULL,\n       caption=\"StatCan Table 11-10-0135\")\n\n\n\n\nShe notes that there has been a substantial overall drop in children in low income since 2015 across all measures, which is excellent news. She considers pushing off her pilot project until after the 2021 census data comes out to first understand if the geographic patterns have changed."
  },
  {
    "objectID": "intro.html#what-you-will-learn-in-this-book",
    "href": "intro.html#what-you-will-learn-in-this-book",
    "title": "1  Introduction",
    "section": "1.2 What you will learn in this book",
    "text": "1.2 What you will learn in this book\nLooking at R code for the first time can be intimidating. If the code looks opaque right now, there is no need to worry. It will be explained in detail in the first chapter and is very much part of the rationale for writing this book. If decisions around what low income metric to pick, or why tongfen is needed to compare census data through time are not clear, again, that will be explained in this book in detail and expanding understanding of data and data analysis is the other big rationale for this book.\nReaders will learn how to reproduce analysis, how to critique analysis, and adapt it for their own purposes. And readers will learn how to conduct their own analysis in the Canadian context, based on questions and use cases relevant to them.\nHopefully the above hypothetical scenario have explained how the adaptability of the R code has made life much easier for several of the subsequent analysis steps, and how little code was needed to gain some insights and communicate results."
  },
  {
    "objectID": "intro_to_r/intro_to_r.html",
    "href": "intro_to_r/intro_to_r.html",
    "title": "Getting started with R and RStudio",
    "section": "",
    "text": "Statistics Canada produces a lot of high quality demographic and economic data for Canada. CMHC complements this with housing data, and municipalities across Canada often provide relevant data through their Open Data portals."
  },
  {
    "objectID": "intro_to_r/intro_to_r.html#r-and-rstudio",
    "href": "intro_to_r/intro_to_r.html#r-and-rstudio",
    "title": "Getting started with R and RStudio",
    "section": "R and RStudio",
    "text": "R and RStudio\nWe will be working in R and the RStudio IDE, although using a different editor like Visual Studio Code works just as well, especially if you are already familiar with it. Within R we will be operating within the tidyverse framework, a group of R packages that work well together and allow for intuitive operations on data via pipes.\nWhile an introduction to R is part of the goal of this book, an we will slowly build up skills as we go, we not give a systematic introduction but rather build up skills slowly as we work on concrete examples. It may be beneficial to supplement this with a more principled introduction to R and the tidyverse.\nDuring the course of this book we will make heavy use of several R packages to facilitate data access, we will introduce them in this chapter."
  },
  {
    "objectID": "intro_to_r/intro_cansim.html",
    "href": "intro_to_r/intro_cansim.html",
    "title": "2  Introduction to cansim",
    "section": "",
    "text": "The cansim R package interfaces with the StatCan NDM that replaces the former CANSIM tables. It can be queried for\n\nwhole tables\nspecific vectors\ndata discovery searching through tables\n\nIt encodes the metadata and allows to work with the internal hierarchical structure of the fields.\nLarger tables can also be imported into a local SQLite database for reuse across sessions without the need to re-download the data, and better performance when subsetting the data."
  },
  {
    "objectID": "intro_to_r/intro_cancensus.html",
    "href": "intro_to_r/intro_cancensus.html",
    "title": "3  Introduction to cancensus",
    "section": "",
    "text": "The cancensus R package interfaces with the CensusMapper API server. It can be queried for\n\ncensus geographies\ncensus data\nhierarchical metadata of census variables\nsome non-census data that comes on census geographies, e.g. T1FF taxfiler data\n\nA slight complication, the cancensus packageneeds an API key. You can sign up for one on CensusMapper."
  },
  {
    "objectID": "basic_descriptive/basic_descriptive.html",
    "href": "basic_descriptive/basic_descriptive.html",
    "title": "Basic descriptive analysis",
    "section": "",
    "text": "The accompanying analysis won’t be very involved, sometimes we will compute percentages or make other simple data manipulations, but generally the analysis will be quite straight-forward. We will focus on how to find data sources that can inform on our question, how to get the data, and how to present and interpret it."
  },
  {
    "objectID": "basic_descriptive/cars_vs_suvs.html",
    "href": "basic_descriptive/cars_vs_suvs.html",
    "title": "4  Cars vs SUVs in Canada",
    "section": "",
    "text": "4.0.1 Question\nAre SUVs and light trucks taking over in Canada?\nThis question is somewhat vague, it’s not clear what taking over means. But the question is clear enough to get us started on some descriptive analysis.\n\n\n4.0.2 Data sources\nData discovery can be challenging, but just typing “statcan motor vehicle sales” into a search engine is a good start and gets us to the StatCan table enumerating data on new motor vehicle sales. We can also use the built-in search functionality in the {cansim} package.\n\nlibrary(dplyr)\n\n\nAttaching package: 'dplyr'\n\n\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n\n\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n\nlibrary(ggplot2)\nlibrary(cansim)\n\nsearch_cansim_cubes(\"motor vehicle sales\") |>\n  select(cansim_table_number,cubeTitleEn,cubeStartDate,cubeEndDate)\n\nRetrieving cube information from StatCan servers...\n\n\n# A tibble: 2 × 4\n  cansim_table_number cubeTitleEn                      cubeStartDate cubeEndDate\n  <chr>               <chr>                            <date>        <date>     \n1 20-10-0001          New motor vehicle sales          1946-01-01    2022-03-01 \n2 20-10-0002          New motor vehicle sales, by typ… 2010-01-01    2021-01-01 \n\n\nThere are two tables with motor vehicle sales, we can inspect them on the web or via the {cansim} package. The second table covers a much shorter time period, and is also less recent. We will check out the first table to see if it fits our needs.\nTo access the web we can simply type view_cansim_webpage(\"20-10-0001\") into the console, which will open the StatCan webpage for Table 20-10-0001. Getting table overview data via the {cansim} package requires to load the table first, which can be slow for larger tables.\n\nget_cansim_table_overview(\"20-10-0001\")\n\nAccessing CANSIM NDM product 20-10-0001 from Statistics Canada\n\n\nParsing data\n\n\nNew motor vehicle sales\nCANSIM Table 20-10-0001\nStart Reference Period: 1946-01-01, End Reference Period: 2022-03-01, Frequency: Monthly\n\nColumn Geography (11)\nNewfoundland and Labrador, Prince Edward Island, Nova Scotia, New Brunswick, Quebec, Ontario, Manitoba, Saskatchewan, Alberta, British Columbia and the Territories, ...\n\nColumn Vehicle type (3)\nPassenger cars, Trucks, Total, new motor vehicles\n\nColumn Origin of manufacture (5)\nNorth America, Total, overseas, Japan, Other countries, Total, country of manufacture\n\nColumn Sales (2)\nUnits, Dollars\n\nColumn Seasonal adjustment (2)\nUnadjusted, Seasonally adjusted\n\n\nThis tells us that Table 20-10-0001 might have the information we need, we check the table notes to better understand what “Trucks” entails.\n\nget_cansim_table_notes(\"20-10-0001\") %>% \n  select(`Member Name`,Note) %>%\n  knitr::kable()\n\n\n\n\n\n\n\n\nMember Name\nNote\n\n\n\n\nNA\nPrior to 1953, data for Canadian and United States manufactured vehicles and overseas manufactured vehicles are not segregated.\n\n\nBritish Columbia and the Territories\nIncludes Yukon, Northwest Territories and Nunavut.\n\n\nTrucks\nTrucks include minivans, sport-utility vehicles, light and heavy trucks, vans and buses.\n\n\nTotal, overseas\nIncludes Japan and other countries.\n\n\nNA\nSeasonally adjusted data for the New Motor Vehicle Sales survey are available for the period between January 1991 to February 2012.\n\n\n\n\n\nIt looks like “Trucks” does includes SUVs, but next to light trucks it also includes heavy trucks and buses. It also includes minivans, and thinking back at our original question, we might want to refine it to include minivans.\nThis allows us to separate passenger cars from basically everything else. Thinking that heavy truck and bus sales probably only make up a small portion, we could use that as a stand-in for our “SUVs and light trucks” in our question. But the match is not ideal and this leaves questions open.\nMaybe Table 20-10-0002 works better for our purposes, time to look at the table overview.\n\nget_cansim_table_overview(\"20-10-0002\")\n\nAccessing CANSIM NDM product 20-10-0002 from Statistics Canada\n\n\nParsing data\n\n\nNew motor vehicle sales, by type of vehicle\nCANSIM Table 20-10-0002\nStart Reference Period: 2010-01-01, End Reference Period: 2021-01-01, Frequency: Annual\n\nColumn Geography (11)\nNewfoundland and Labrador, Prince Edward Island, Nova Scotia, New Brunswick, Quebec, Ontario, Manitoba, Saskatchewan, Alberta, British Columbia and the Territories, ...\n\nColumn Vehicle type (6)\nPassenger cars, Trucks, Light trucks, Heavy trucks, Buses, Total, new motor vehicles\n\nColumn Sales (2)\nUnits, Dollars\n\n\nThe frequency is only annual as opposed to the monthly data from the previous table, but the breakdown of vehicle types looks much better for our purposes, it allows us to distinguish light trucks from heavy trucks and buses. Time to check the table notes for more details on the definitions.\n\nget_cansim_table_notes(\"20-10-0002\") %>% \n  select(`Member Name`,Note) %>%\n  knitr::kable()\n\n\n\n\n\n\n\n\nMember Name\nNote\n\n\n\n\nBritish Columbia and the Territories\nIncludes Yukon, Northwest Territories and Nunavut.\n\n\nTrucks\nTrucks include minivans, sport-utility vehicles, light and heavy trucks, vans and buses.\n\n\nLight trucks\nLight trucks: include minivans, sport-utility vehicles, light trucks and vans.\n\n\nHeavy trucks\nHeavy trucks: include class 4, 5, 6, 7 and 8 trucks.\n\n\n\n\n\nThis looks like it fits what we need, we want to compare unit sales of Passenger cars to Light trucks.\n\n\n4.0.3 Data acquisition\nGetting the data is easy now. The {cansim} package will automatically add a native Date column, to convert annual data to dates it defaults to July 1st of that year. While it is a sensible default to assign a mid-year date to annual data, later on for plotting it will be more convenient for us to set the date at January 1st, so we change override the default using the optional default_month argument.\n\ndata <- get_cansim(\"20-10-0002\", default_month = 1)\n\nReading CANSIM NDM product 20-10-0002 from cache.\n\ndata |> select(Date,GEO,`Vehicle type`,Sales,val_norm) %>%\n  head()\n\n# A tibble: 6 × 5\n  Date       GEO    `Vehicle type`            Sales      val_norm\n  <date>     <chr>  <fct>                     <fct>         <dbl>\n1 2010-01-01 Canada Total, new motor vehicles Units       1584499\n2 2010-01-01 Canada Total, new motor vehicles Dollars 52315609000\n3 2010-01-01 Canada Passenger cars            Units        710214\n4 2010-01-01 Canada Passenger cars            Dollars 18982437000\n5 2010-01-01 Canada Trucks                    Units        874285\n6 2010-01-01 Canada Trucks                    Dollars 33333173000\n\n\nQuick inspection of the data, using the columns we identified in the overview, helps identify the basic structure of the data.\n\n\n4.0.4 Data preparation\nThere is not much data preparation needed, we just filter down to the data we are interested in.\n\nplot_data <- data |>\n  filter(`Vehicle type` %in% c(\"Passenger cars\",\"Light trucks\"),\n         Sales==\"Units\",\n         GEO==\"Canada\")\n\n\n\n4.0.5 Analysis and visualization\nTime to lake a look what this looks like, to plot we filter for the overall Canadian data series, and tell ggplot to map Date on the x-axis, the values colum `VALUE` on the y-axis, and colour by vehicle type.\n\nggplot(plot_data,aes(x=Date,y=VALUE,colour=`Vehicle type`)) +\n  geom_line() \n\n\n\n\nThis is looking good, time to clean up the graph a bit. We add markers for the data points, nicer axis labels, as well as a title and labels.\n\nggplot(plot_data,aes(x=Date,y=VALUE,colour=`Vehicle type`)) +\n  geom_point(shape=21) +\n  geom_line() +\n  scale_y_continuous(labels=scales::comma) +\n  scale_color_manual(labels=c(\"Light trucks\"=\"Light trucks, SUVs\\nminvans and vans\"),\n                     values=c(\"Light trucks\"=\"brown\",\"Passenger cars\"=\"steelblue\")) +\n  labs(title=\"New motor vehicle sales in Canada\",\n       x=NULL,y=\"Annual number of vehicles.\",\n       caption=\"StatCan Table 20-10-0002\")\n\n\n\n\nThis answers our question in that more light trucks, SUVs, minivans and vans are sold than cars, and the gap has been growing. But the data only starts in 2010, and we suspect that things weren’t always this way. At what point did SUVs and light trucks overtake new car sales?\nTo answer than we need to jump back and load the other time series. It won’t let us separate out heavy trucks and buses, but we can estimate how bad the difference is by comparing it to this data.\nWe load the data and filter it down to the parts that we are interested in.\n\ndata2 <- get_cansim(\"20-10-0001\")\n\nReading CANSIM NDM product 20-10-0001 from cache.\n\nplot_data2 <- data2 |>\n  filter(`Vehicle type` %in% c(\"Passenger cars\",\"Trucks\"),\n         Sales==\"Units\",\n         `Origin of manufacture`==\"Total, country of manufacture\",\n         `Seasonal adjustment`==\"Unadjusted\",\n         GEO==\"Canada\")\n\nA quick plot gives us a general idea what this looks like.\n\nplot_data2 %>%\n  ggplot(aes(x=Date,y=VALUE,colour=`Vehicle type`)) +\n  geom_line()\n\n\n\n\nThere is a strong seasonal pattern in vehicle sales, for now we will just aggregate it to annual sales so we can compare it with the previous data.\n\nplot_data2_annual <- plot_data2 |>\n  mutate(Year=strftime(Date,\"%Y\")) |>\n  group_by(Year,`Vehicle type`) |>\n  summarise(VALUE=sum(VALUE), n=n(),.groups=\"drop\") |>\n  mutate(Date=as.Date(paste0(Year,\"-01-01\"))) |>\n  filter(n==12)  # only use years with full 12 months of data\n\nggplot(plot_data2_annual,aes(x=Date,y=VALUE,colour=`Vehicle type`)) +\n  geom_line()\n\n\n\n\nTime to combine this with our previous data. This tells us that the most interesting change happened 1985 and onward, so we will discard earlier years. One quick sanity check is to see if the annual passenger car sales derived from the two series agree for the years where they are in common.\n\nplot_data %>%\n  filter(`Vehicle type`==\"Passenger cars\") %>%\n  select(Date,`Vehicle type`,VALUE1=VALUE) %>%\n  left_join(plot_data2_annual,by=c(\"Date\",\"Vehicle type\")) %>%\n  mutate(diff=VALUE1-VALUE) %>%\n  select(Year,VALUE1,VALUE,diff)\n\n# A tibble: 12 × 4\n   Year  VALUE1  VALUE  diff\n   <chr>  <dbl>  <dbl> <dbl>\n 1 2010  710214 710214     0\n 2 2011  691079 691079     0\n 3 2012  759024 759024     0\n 4 2013  760924 760920     4\n 5 2014  760449 760449     0\n 6 2015  712322 712322     0\n 7 2016  661088 661088     0\n 8 2017  646960 646960     0\n 9 2018  586357 586357     0\n10 2019  496851 496851     0\n11 2020  325494 325494     0\n12 2021  345350 345350     0\n\n\nThe data for all years agrees, except for 2013 where one series counts 4 more passenger cars.\n\nbind_rows(plot_data %>% filter(`Vehicle type`!=\"Passenger cars\"),\n          plot_data2_annual %>% filter(Date>=as.Date(\"1985-01-01\"))) %>%\n  ggplot(aes(x=Date,y=VALUE,colour=`Vehicle type`)) +\n  geom_point(shape=21) +\n  geom_line() +\n  scale_y_continuous(labels=scales::comma) +\n  scale_color_manual(labels=c(\"Light trucks\"=\"Light trucks, SUVs\\nminvans and vans\"),\n                     values=c(\"Light trucks\"=\"brown\",\"Passenger cars\"=\"steelblue\",\n                              \"Trucks\"=\"purple\")) +\n  theme(legend.position = \"bottom\") +\n  labs(title=\"New motor vehicle sales in Canada\",\n       x=NULL,y=\"Annual number of vehicles.\",\n       caption=\"StatCan Tables 20-10-0001, 20-10-0002\")\n\n\n\n\n\n\n4.0.6 Interpretation\nThis confirms our initial suspicion that the “Trucks” category is dominated by light trucks, SUVs, minivans and vans, at least for the years 2010 onwards where we have data for both. Which gives us confidence to say that truck and SUV sales caught up to passenger cars sales by around 1997, and the two evolved fairly parallel until 2009, after which SUVs and light trucks increased dramatically and passenger car sales fell."
  },
  {
    "objectID": "advanced_descriptive/advanced_descriptive.html",
    "href": "advanced_descriptive/advanced_descriptive.html",
    "title": "Advanced descriptive analysis",
    "section": "",
    "text": "Building on the section of basic descriptive analysis we will move into more advanced data processing and descriptive analysis. This will involve mixing of different datasets to tease out finer aspects. We will learn how to group and summarize data, and how to use joins."
  },
  {
    "objectID": "advanced_descriptive/advanced_descriptive_bc_migration.html",
    "href": "advanced_descriptive/advanced_descriptive_bc_migration.html",
    "title": "5  BC migration",
    "section": "",
    "text": "Let’s first try and understand what the headline really means. B.C. “welcoming” people refers to people moving to the province from elsewhere, either from other provinces or internationally. So this is referring to gross in-migration. But reading the text of the press release it immediately pivots to a different concept, saying that “B.C.’s net migration reached 100,797 people in 2021”. It helpfully explains that net migration is the difference between people moving here and people moving away. Which is quite different from the number of people B.C. “welcomed” that year, or the number of people “moving to the province in 2021” as implied by the title and the first sentence of the press release.\nSo here comes the first difficulty, the press release is contradicting itself by mixing two concepts. That leads us to formulate a fairly broad question that should help clear this up.\n\n5.0.1 Question\nHow many people has B.C. welcomed, net and gross, how has that changed over the last 6 decades, and how should this be interpreted?\n\n\n5.0.2 Data sources\nTo start, let’s figure out where that data point comes from.\nThe press release references StatCan as the source, let’s search through the StatCan tables. Google usually works reasonably well, but we can also search programmatically. We are looking for migration estimates from the quarterly demographic estimates to get the most up-to-data population estimates from StatCan. For results we just need the first two columns, that table number and the title.\n\nlibrary(tidyverse)\nlibrary(cansim)\n\nsearch_cansim_cubes(\"migration\") |> \n  filter(grepl(\"quarterly\",cubeTitleEn)) |>\n  arrange(desc(cubeEndDate)) |> \n  select(1:2)\n\n# A tibble: 2 × 2\n  cansim_table_number cubeTitleEn                                               \n  <chr>               <chr>                                                     \n1 17-10-0020          Estimates of the components of interprovincial migration,…\n2 17-10-0040          Estimates of the components of international migration, q…\n\n\nIt looks like Table 17-10-0020 and 17-10-0040 are what we are looking for. Let’s load in the data and inspect the first couple of rows for BC.\n\n\n5.0.3 Data acquisition\n\ninterprovincial <- get_cansim(\"17-10-0020\")\ninternational <- get_cansim(\"17-10-0040\")\n\ninterprovincial |>\n  filter(GEO==\"British Columbia\") |>\n  select(GEO,Date,`Interprovincial migration`,val_norm) |>\n  tail()\n\n# A tibble: 6 × 4\n  GEO              Date       `Interprovincial migration` val_norm\n  <chr>            <date>     <fct>                          <dbl>\n1 British Columbia 2021-04-01 In-migrants                    31926\n2 British Columbia 2021-04-01 Out-migrants                   16636\n3 British Columbia 2021-07-01 In-migrants                    19352\n4 British Columbia 2021-07-01 Out-migrants                   13575\n5 British Columbia 2021-10-01 In-migrants                    12120\n6 British Columbia 2021-10-01 Out-migrants                    8787\n\n\nFor inter-provincial migration we get in and out migration counts for every quarter. Let’s also inspect the international migration data.\n\ninternational |>\n  filter(GEO==\"British Columbia\") |>\n  select(GEO,Date,`Components of population growth`,val_norm) |>\n  tail()\n\n# A tibble: 6 × 4\n  GEO              Date       `Components of population growth` val_norm\n  <chr>            <date>     <fct>                                <dbl>\n1 British Columbia 2021-07-01 Net non-permanent residents           9035\n2 British Columbia 2021-10-01 Immigrants                           23281\n3 British Columbia 2021-10-01 Emigrants                             3759\n4 British Columbia 2021-10-01 Returning emigrants                    581\n5 British Columbia 2021-10-01 Net temporary emigrants                779\n6 British Columbia 2021-10-01 Net non-permanent residents          -6718\n\n\nHere we get immigrants, emigrants, returning emigrants, but for temporary emigrants and non-permanent residents we only get net change. That puts a bit of a damper on our ambition to look at gross migration, for those last two categories net is all we have.\n\n\n5.0.4 Data preparation\nNext we got to wrangle this data into a useful format. We are interested in all of these components, so we need to join these two data series together. We will retain the GeoUID, GEO, Components of population growth, Date and val_norm columns, which requires some renaming and then defining factor levels so that they stack nicely later in our plots. We also flip the sign on out-migrants and emigrants, as these are out-flows. To make sure those two time series start at the same time we cut it off appropriately.\nThe press release talked about annual change, so we do a rolling sum over 4 quarters, right-aligning the data so it’s for the period of the preceding year.\n\nmigration_data <- bind_rows(\n  interprovincial |> \n    select(GeoUID,GEO,Date,\n           `Components of population growth`=`Interprovincial migration`,val_norm) |>\n    mutate(`Components of population growth`=\n             paste0(\"Interprovincial \",tolower(`Components of population growth`))),\n  international |> \n    select(GeoUID,GEO,Date,`Components of population growth`,val_norm)\n) |>\n  mutate(`Components of population growth`=\n           factor(`Components of population growth`,\n                  levels=c(\"Interprovincial out-migrants\",\n                           \"Emigrants\",\n                           \"Interprovincial in-migrants\",\n                           \"Immigrants\",\n                           \"Returning emigrants\",\n                           \"Net temporary emigrants\",\n                           \"Net non-permanent residents\"))) |>\n  mutate(value=ifelse(`Components of population growth` %in% \n                        c(\"Interprovincial out-migrants\",\"Emigrants\"),\n                      -val_norm,val_norm)) |>\n  filter(Date>=pmax(min(interprovincial$Date),min(international$Date))) |>\n  group_by(GeoUID,`Components of population growth`) |>\n  arrange(Date) |>\n  mutate(annual=zoo::rollsum(value,k=4,na.pad = TRUE,align = \"right\")) |>\n  filter(!is.na(annual)) |>\n  ungroup()\n\nWe will also need net migration stats, so let’s compute these by summing of the components,\n\nnet_migration <- migration_data |> \n  group_by(Date,GEO,GeoUID) |>\n  summarize(value=sum(value),annual=sum(annual),.groups=\"drop\") |>\n  mutate(`Components of population growth`=\"Net migration\")\n\n\n\n5.0.5 Analysis and visualization\nTime to make a graph.\n\nmigration_colours <- setNames(MetBrewer::met.brewer(\"Archambault\",7),\n                              migration_data$`Components of population growth` %>% \n                                levels %>% rev)\n\nggplot(migration_data |> filter(GEO==\"British Columbia\")) +\n  geom_area(aes(x=Date,y=annual,fill=fct_rev(`Components of population growth`)),\n           stat=\"identity\") +\n  scale_y_continuous(labels=scales::comma) +\n  geom_line(data=net_migration |> filter(GEO==\"British Columbia\"),\n            aes(x=Date,y=annual)) +\n  scale_fill_manual(values=migration_colours) +\n  labs(title=\"BC Year over year migration\",\n       y=\"Year over year change\",x=NULL,fill=\"Components of population change\",\n       caption=\"StatCan Tables 17-10-0020, 17-10-0040\")\n\n\n\n\nThis shows us that the press report was most likely talking did not mean to talk about number of people B.C. has “welcomed” or that “moved to the province” but instead the difference between the number of people it welcomed and the number of people it bid farewell.\nAnd the net migration is indeed at record levels. At least in absolute terms. But B.C. now is very different from B.C. in the 60s at the start of this time series. How can we compare net migration over time in a more meaningful way? Normalizing by population is a good option here. Let’s grab the data and take a look how B.C. population has changed.\n\npop_data <- get_cansim(\"17-10-0009\") |>\n  select(GEO,Date,Population=val_norm)\n\npop_data |> \n  filter(GEO==\"British Columbia\") |>\n  ggplot(aes(x=Date,y=Population)) +\n  geom_line() +\n  scale_y_continuous(labels=scales::comma) +\n  labs(title=\"Population estimates for British Columbia\",\n       y=\"Number of people\",\n       x=NULL,\n       caption=\"StatCan Table 17-10-0009\")\n\n\n\n\nIndeed, the trend is quite strong. Let’s fold that in and normalize by population.\n\nmigration_data |> \n  left_join(pop_data, by=c(\"GEO\",\"Date\")) |>\n  filter(GEO==\"British Columbia\") |>\n  ggplot() +\n  geom_area(aes(x=Date,y=annual/Population,fill=fct_rev(`Components of population growth`)),\n           stat=\"identity\") +\n  scale_y_continuous(labels=scales::percent) +\n  geom_line(data=net_migration |> \n              left_join(pop_data, by=c(\"GEO\",\"Date\")) |>\n              filter(GEO==\"British Columbia\"),\n            aes(x=Date,y=annual/Population)) +\n  scale_fill_manual(values=migration_colours) +\n  labs(title=\"BC Year over year BC Year over year migration\",\n       y=\"Year over year change per population\",x=NULL,\n       fill=\"Components of population change\",\n       caption=\"StatCan Tables 17-10-0020, 17-10-0040, 17-10-0009\")\n\n\n\n\nHere the picture looks a little different. Net migration per capita is at its highest since the 90s, but the past 60 years there were several periods where it was larger.\nThe press report also mentioned that B.C.’s interprovincial migration numbers are higher than any other province. This is easy to check now.\n\nmigration_data_interprovinicial <- migration_data |>\n  left_join(pop_data, by=c(\"GEO\",\"Date\")) |>\n  filter(grepl(\"Interprovincial\",`Components of population growth`))\n\nnet_interprovincial <- migration_data_interprovinicial |>\n  group_by(GEO,Date) |>\n  summarize(value=sum(value),\n            annual=sum(annual),\n            Population=first(Population),\n            .groups=\"drop\")\n\nmigration_data_interprovinicial |> \n  filter(GEO!=\"Canada\") |>\n  filter(Date==max(Date)) |>\n  ggplot(aes(y=GEO,x=annual)) +\n  geom_bar(stat=\"identity\",\n           aes(fill=fct_rev(`Components of population growth`))) +\n  geom_boxplot(data=net_interprovincial |> \n                 filter(GEO!=\"Canada\") |>\n                 filter(Date==max(Date))) +\n  scale_fill_manual(values=migration_colours[grepl(\"Interprov\",names(migration_colours))]) +\n  scale_x_continuous(labels=scales::comma) +\n  labs(title=\"Most recent year migration\",\n       fill=\"Components of population growth\",\n       y=NULL,x=\"Year over year change\",\n       caption=\"StatCan Tables 17-10-0020, 17-10-0040, 17-10-0009\")\n\n\n\n\nIn absolute number B.C. indeed has both the highest interprovincial in-migration and interprovincial net-migration among all provinces. But the provinces have vastly different sizes, so that’s not really a fair comparison. Again, we can normalize by population.\n\nmigration_data_interprovinicial |> \n  filter(GEO!=\"Canada\") |>\n  filter(Date==max(Date)) |>\n  ggplot(aes(y=GEO,x=annual/Population)) +\n  geom_bar(stat=\"identity\",\n           aes(fill=fct_rev(`Components of population growth`))) +\n  geom_boxplot(data=net_interprovincial |> \n                 filter(GEO!=\"Canada\") |>\n                 filter(Date==max(Date))) +\n  scale_fill_manual(values=migration_colours[grepl(\"Interprov\",names(migration_colours))]) +\n  scale_x_continuous(labels=scales::percent) +\n  labs(title=\"Most recent year migration\",\n       fill=\"Components of population growth\",\n       y=NULL,x=\"Year over year change per capita\",\n       caption=\"StatCan Tables 17-10-0020, 17-10-0040, 17-10-0009\")\n\n\n\n\nViewed this way B.C.’s interprovincial in-migration and net migration still looks good, but many of the other provinces beat out that growth rate.\nFor completeness we can also just show the full graph that includes the international migration components.\n\nmigration_data |> \n  left_join(pop_data, by=c(\"GEO\",\"Date\")) |>\n  filter(Date==max(Date)) |>\n  ggplot(aes(y=GEO,x=annual/Population)) +\n  geom_bar(stat=\"identity\",aes(fill=fct_rev(`Components of population growth`))) +\n  geom_boxplot(data=net_migration |> \n                 left_join(pop_data, by=c(\"GEO\",\"Date\")) |> \n                 filter(Date==max(Date))) +\n  scale_fill_manual(values=migration_colours) +\n  scale_x_continuous(labels=scales::percent) +\n  labs(title=\"Most recent year migration\",\n       fill=\"Components of population growth\",\n       y=NULL,x=\"Year over year change per capita\",\n       caption=\"StatCan Tables 17-10-0020, 17-10-0040, 17-10-0009\")\n\n\n\n\n\n\n5.0.6 Interpretation\nThis answers our question, the latest annual net migration edges over the 100,000 people mark, and in absolute terms this is the highest it’s been over at least 60 years. And B.C.’s interprovincial (net) in-migration was the highest in Canada in absolute terms. But what can we learn from that?\nB.C. 60 years ago is very different from B.C. today. To account for that we can normalize by population, and the relative net migration has been higher at several times during the past 60 years, most recently in the 90s.\nWe also note that big dip in net-migration during COVID-19. It is not clear if the current heights are a bounce-back to make up for the comparatively low net in-migration during the pandemic, or if it is simply reverting back to the increasing trend we have seen over the past 10 years."
  }
]